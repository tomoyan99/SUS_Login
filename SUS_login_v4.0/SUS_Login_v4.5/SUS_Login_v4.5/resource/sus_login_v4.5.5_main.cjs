(()=>{"use strict";const t=require("fs"),e=require("puppeteer"),a=require("readline");process.stdin.setEncoding("utf8");const s="",o="\b\b[0K",i="\b[0K",r=t=>new Promise((t=>{const e=process.stdin,a=e.isRaw,s=(o="")=>{if(e.off("data",s),e.pause(),e.setRawMode(a),27===o.charCodeAt(0))t("");else{for(const t of o)process.stdout.write("*");t(o)}};e.setRawMode(!0),e.resume(),e.on("data",s)}));async function n(t,e=!1){if(!1===e){const e=(0,a.createInterface)({input:process.stdin,output:process.stdout});return new Promise((a=>{e.question(t,(t=>{e.close(),a(t)}))}))}if(!0===e){let e="";process.stdout.write(t);let a="";for(;;){if(e=await r(),e.charCodeAt(0)-31<=0&&13!==e.charCodeAt(0)&&8!==e.charCodeAt(0)&&3!==e.charCodeAt(0)&&process.stdout.write(i),"\r"===e)return process.stdout.write(i),console.log(),a;e===s&&(process.stdout.write(i),process.exit(-1)),"\b"!==e?"\t"!==e?a+=e:e="":""!==a?(process.stdout.write(o),a=a.slice(0,a.length-1)):process.stdout.write(i)}}}const c={CtrlC:"",erathe:"\b\b[0K",nowrite:"\b[0K",rightClear:"[0K",lineClear:"[2K",startLine:(t=1,e=1)=>`[${t};${e}H`,initialLine:(t=1)=>`[${t}G`,up:"[A",down:"[B",right:"[C",left:"[D",fg_black:"[30m",fg_red:"[31m",fg_green:"[32m",fg_yellow:"[33m",fg_blue:"[34m",fg_magenta:"[35m",fg_cyan:"[36m",fg_white:"[37m",fg_reset:"[0m",bg_black:"[40m",bg_red:"[41m",bg_green:"[42m",bg_yellow:"[43m",bg_blue:"[44m",bg_magenta:"[45m",bg_cyan:"[46m",bg_white:"[47m",bg_reset:"[49m"};async function l(t={Menu:{head:[],body:[],foot:[]}}){let e="";const a=await class{constructor(){this.Options={},this.index=[0,0],this.index_old=[0,0],this.H_Start=0,this.H_Line=0,this.H_End=0,this.B_Start=0,this.B_Line=0,this.B_End=0,this.F_Start=0,this.F_Line=0,this.F_End=0,this.F_len=0,this.errorStatus_Old=t.errorStatus}static async build(t){const e=new class extends(this){constructor(){super()}async printCyan(){const t=this.B_Start+this.index[0],e=this.B_Start+this.index_old[0],a=this.B_End,s=this.Options.body[this.index[0]],o=this.Options.body[this.index_old[0]];process.stdout.write(`${c.startLine(e)}`),o.forEach(((t="",e)=>{process.stdout.write(`${t}\t`)})),process.stdout.write(`${c.startLine(t)}`),s.forEach(((t="",e)=>{const a=t.replace(/\x1b\[([0-9]{1,3}((;[0-9]{1,3})*)?)?[mGK]/g,""),s=e===this.index[1]?c.fg_cyan:c.fg_reset,o=e===this.index[1]?a:t;process.stdout.write(`${s}${o}${c.fg_reset}\t`)})),process.stdout.write(`${c.startLine(a)}\n`)}async printChoice(){const t=this.F_End,e=this.P_Start;process.stdout.write(`${c.startLine(t,e)}\t`),process.stdout.write(`${this.Options.body[this.index[0]][this.index[1]]}`),process.stdout.write(`${c.rightClear}`)}async printPrompt(){const t=this.Options;console.clear();for(const e in t)t[e].forEach((t=>{t.forEach((t=>{process.stdout.write(`${t}\t`)})),console.log()}))}async render(t){await this.clearIndex(),await this.setProperties(t),await this.printPrompt(),await this.printCyan(),await this.printChoice()}};return await e.render(t),e}async setProperties(t){this.Options=t.Menu,this.nowPrompt=()=>this.Options.body[this.index[0]][this.index[1]],this.H_Start=1,this.H_Line=t.Menu.head.length,this.H_End=this.H_Start+this.H_Line-1,this.B_Start=this.H_End+1,this.B_Line=t.Menu.body.length,this.B_End=this.B_Start+this.B_Line-1,this.F_Start=this.B_End+1,this.F_Line=t.Menu.foot.length,this.F_End=this.F_Start+this.F_Line-1,this.F_Len=t.Menu.foot[this.F_Line-1].length,this.P_Start=this.F_Len+5,this.P_Len=this.nowPrompt().length,this.P_End=this.P_Start+this.P_Len}async clearIndex(){this.index=[0,0],this.index_old=[0,0]}get LineNum(){return{H_Start:this.H_Start,H_Line:this.H_Line,H_End:this.H_End,B_Start:this.B_Start,B_Line:this.B_Line,B_End:this.B_End,F_Start:this.F_Start,F_Line:this.F_Line,F_End:this.F_End,F_Len:this.F_Len,P_Start:this.F_Len+5,P_Len:this.nowPrompt().length,P_End:this.P_Start+this.P_Len}}get indexMax(){return t.Menu.body.length-1}get choosing(){return{index:[a.index[0],a.index[1]],str_raw:t.Menu.body[a.index[0]][a.index[1]],str:t.Menu.body[a.index[0]][a.index[1]].replace(/\x1b\[([0-9]{1,3}((;[0-9]{1,3})*)?)?[mGK]/g,"")}}}.build(t);for(setInterval((async()=>{a.errorStatus_Old!==t.errorStatus&&(await a.render(t),a.errorStatus_Old=t.errorStatus)}),10);13!==e.charCodeAt(0);)e=await w(a),await a.printCyan(),await a.printChoice();return console.log("\n"),a.choosing}process.stdin.setEncoding("utf8");const w=t=>new Promise((e=>{const a=process.stdin,s=a.isRaw,o=i=>{i===c.CtrlC&&process.exit(-1);const r={"[A":function(){t.index[0]--,t.index[0]<0&&(t.index[0]=t.indexMax),void 0===t.Options.body[t.index[0]][t.index[1]]&&(t.index[1]=0)},"[B":function(){t.index[0]++,t.index[0]>t.indexMax&&(t.index[0]=0),void 0===t.Options.body[t.index[0]][t.index[1]]&&(t.index[1]=0)},"[C":function(){t.Options.body[t.index[0]].length>1&&t.index[1]<t.Options.body[t.index[0]].length-1&&t.index[1]++},"[D":function(){t.index[1]>=1?t.index[1]--:t.index[1]}};try{t.index_old=t.index.concat(),r[i]()}catch(t){}a.off("data",o),a.pause(),a.setRawMode(s),e(i)};a.setRawMode(!0),a.resume(),a.on("data",o)})),g={value:(new Date).valueOf(),year:(new Date).getFullYear(),month:(new Date).getMonth()+1,date:(new Date).getDate(),hour:(new Date).getHours(),minute:(new Date).getMinutes(),sec:(new Date).getSeconds(),yearl2d:parseInt((new Date).getFullYear()).toString().slice(-2),getToday:function(){return`${this.year}-${this.month.toString().padStart(2,"0")}-${this.date.toString().padStart(2,"0")}-${this.hour.toString().padStart(2,"0")}-${this.minute.toString().padStart(2,"0")}-${this.sec.toString().padStart(2,"0")}`},getTodayJP:function(){return`${this.year}年${this.month.toString().padStart(2,"0")}月${this.date.toString().padStart(2,"0")}日${this.hour.toString().padStart(2,"0")}時${this.minute.toString().padStart(2,"0")}分${this.sec.toString().padStart(2,"0")}秒`},getNend:function(){let t=this.year;return 1<=this.month&&this.month<=3&&t--,parseInt(t.toString().slice(-2))},whichTerm:function(){return this.month>=4&&this.month<=9?"bf":"af"},isStartNend:function(t={year:0,month:0,hour:0,value:0,lastterm:""}){return this.value-t.value>=157788e5||t.lastterm!==this.whichTerm()}};process.stdin.setEncoding("utf8");const u="",d="\b[0K",h=t=>new Promise((t=>{const e=process.stdin,a=e.isRaw,s=(o="")=>{e.off("data",s),e.pause(),e.setRawMode(a),t("\r"===o||o===u?o:"")};e.setRawMode(!0),e.resume(),e.on("data",s)}));async function f(t="exit",e="[何かキーを押して終了します]"){let a="";for(process.stdout.write(`${e}\n`);;)if(a=await h(),""!==a){if("\r"===a){process.stdout.write(d),console.log();break}a===u&&process.exit(-1)}if("exit"!==t){if("pass"===t)return 0;throw new Error("modeはpassかexitで設定してください")}process.exit(0)}const _=require("child_process"),p=require("dns");function m(){return new Promise(((t,e)=>{p.lookup("www.google.com",(e=>{e&&"ENOTFOUND"===e.code?t(!1):t(!0)}))}))}const y=require("timers");class b{static wasChanged=!1;constructor(){this.head=[],this.body=[],this.foot=[],this.default={head:[],body:[],foot:[]},this.error={head:[],body:[],foot:[]},this.errorStatus=""}static async build(t,e=void 0){const a=new b;return a.default={head:t.head,body:t.body,foot:t.foot},void 0!==e&&(a.error={head:e.head,body:e.body,foot:e.foot}),await a.setStatus(),await a.setMenu(a.errorStatus),a}static get networkConnected(){return m()}get Menu(){return{head:this.head,body:this.body,foot:this.foot}}static async switchStatus(){this.wasChanged=!this.wasChanged}async setStatus(){return this.errorStatus=await m()?"normal":"error",this}async setMenu(t="normal"){return"normal"===t?(this.head=this.default.head,this.body=this.default.body,this.foot=this.default.foot):"error"===t&&(this.head=this.error.head,this.body=this.error.body,this.foot=this.error.foot),this}}const $=t=>new Promise((e=>setTimeout(e,t)));async function S(t){t.last_upd={year:g.year,month:g.month,date:g.date,value:g.value,lastterm:g.whichTerm()};const a=await(0,e.launch)({headless:"new",slowMo:5,defaultViewport:null,channel:"chrome"});try{const e=await async function(t,e){const a=e.sclass,s=e.username,o=e.password,i=await t.newPage(),r=a.url;await i.setRequestInterception(!0),i.on("request",(t=>{-1!==["image","stylesheet","font","script"].indexOf(t.resourceType())?t.abort():t.continue()}));try{await i.goto(r,{waitUntil:"load",timeout:0});const n=a.target.name,l=a.target.pass,w=a.target.submit;(await t.pages())[0].close(),await i.waitForSelector(w,{timeout:1e4}),await i.click(w),await i.waitForSelector(n,{timeout:1e4}),await i.type(n,s),await i.waitForSelector(l,{timeout:1e4}),await i.type(l,o),await Promise.all([i.waitForSelector(w,{timeout:1e4}),i.click(w)]),console.log("sclassログイン完了");const g="div#pmenu4";await i.evaluate((()=>{window.scroll(0,0)})),await i.waitForSelector(g,{visible:!0,timeout:1e4}),await i.hover(g);const u=await i.$eval(g,(t=>`#${Array.from(t.children).filter((t=>"学生時間割表"===t.text))[0].id}`));await i.waitForSelector(u,{visible:!0,timeout:1e4}),await i.click(u,{delay:1e3});const d="select#form1\\3A HyojiKeishiki",h="select#form1\\3A htmlGakki",f="input#form1\\3A search";await i.waitForSelector(d,{visible:!0,timeout:1e4}),await i.select(d,"1"),await i.select(h,"0"),await i.click(f);const _="table#form1\\3A standardJugyoTimeSchedule00List";await i.waitForSelector(_,{visible:!0,timeout:1e4});const p="table#form1\\3A standardJugyoTimeSchedule01List";async function m(t,e){const a=`table#form1\\3A standardJugyoTimeSchedule00List td.${t} span`,s=`table#form1\\3A standardJugyoTimeSchedule01List td.${t} span`;return{bf:Array.from(new Set(await e.$$eval(a,(t=>t.map((t=>t.textContent)))))),af:Array.from(new Set(await e.$$eval(s,(t=>t.map((t=>t.textContent))))))}}await i.waitForSelector(p,{visible:!0,timeout:1e4});let y=await m("jugyoCd",i),b=await m("jugyoMei",i),$={bf:[],af:[]};for(let S=0;S<y.bf.length;S++)$.bf.push({code:y.bf[S],name:b.bf[S].replace(/ (.*?) .*/g,"$1").replace("\t","")});for(let x=0;x<y.af.length;x++)$.af.push({code:y.af[x],name:b.af[x].replace(/ (.*?) .*/g,"$1").replace("\t","")});return console.log(c.fg_green+"履修科目コード及び科目名取得完了"+c.fg_reset),console.log("続いて、SOLAから科目ページリンクの取得を行います"),$}catch(k){throw console.log(k),new Error(c.fg_red+"[保存] データの保存に失敗しました。暗号化にバグが生じている可能性があるため、暇なときにでも佐野まで報告してもらえると助かります(笑)"+c.fg_reset)}}(a,t),s=await async function(t,e,a){const s=e.sola,o=e.username,i=e.password,r=await t.newPage();await r.goto("https://sola.sus.ac.jp",{waitUntil:"domcontentloaded",timeout:0});const n=s.target.name,l=s.target.pass,w=s.target.submit,g=await t.pages();return await g[0].close(),await r.waitForSelector(n,{visible:!0,timeout:3e4}),await r.type(n,o),await r.click(w),await r.waitForSelector(l,{visible:!0,timeout:3e4}),await r.type(l,i),await r.click(l,{delay:800}),await r.click(w),await t.waitForTarget((async t=>{if("https://sola.sus.ac.jp/"===t.url())return t})),console.log("SOLAログイン完了"),await Promise.all(a.bf.map((async(e,a)=>{await $(800*a),e.url=await x(t,e)}))),console.log(c.fg_green+"前期科目ページURL取得完了"+c.fg_reset),await Promise.all(a.af.map((async(e,a)=>{await $(800*a),e.url=await x(t,e)}))),console.log(c.fg_green+"後期科目ページURL取得完了"+c.fg_reset),await t.close(),a}(a,t,e);return console.log("履修科目データの登録が完了しました"),s}catch(t){throw t}}async function x(t,e){const a=await t.newPage();await a.setRequestInterception(!0),a.on("request",(t=>{-1!==["image","stylesheet","font"].indexOf(t.resourceType())?t.abort():t.continue()})),await a.goto("https://sola.sus.ac.jp/course/search.php?areaids=core_course-course&q="+e.code,{waitUntil:"domcontentloaded",timeout:0}),await a.waitForSelector("div.last a.aalink",{visible:!0,timeout:2e3}).catch((()=>"https://sola.sus.ac.jp/"));const s=await a.$eval("div.last a.aalink",(t=>t.href)).catch((()=>"https://sola.sus.ac.jp/")),o=await a.$eval("div.last a.aalink",(t=>parseInt(t.textContent.match(/[0-9][0-9]_/)[0].replace(/_/,"")))).catch((()=>null));return await a.close(),null===o||o===g.getNend()?(console.log(s),s):o!==g.getNend()?"https://sola.sus.ac.jp/":void 0}const k=require("os"),v={key:(0,k.hostname)(),async strToDec(t){let e=0;for(let a=0;a<t.length;a++)e+=t.slice(a,a+1).charCodeAt(0);return e},async encrypt(t){const e=JSON.stringify(t),a=await this.strToDec(this.key);let s,o,i=[];i[0]=e;let r=0,n=a;for(o=1;r<4e6;o++)r=2*n*String(o).length,n=r;const c=o-1;for(s=0;s<c;s++){i[s+1]="";for(let t=0;t<i[s].length;t++){const e=i[s].charCodeAt(t)^a+s,o=String.fromCharCode(e);i[s+1]+=o+s}}try{return i[s]}catch(t){throw console.log("暗号化に失敗しました"),"暗号化エラー"}},async decrypt(e){const a=(0,t.readFileSync)(e,"utf-8"),s=await this.strToDec(this.key);let o,i,r=[];r[0]=a;let n=0,c=s;for(i=1;n<4e6;i++)n=2*c*String(i).length,c=n;const l=i-1;for(o=0;o<l;o++){r[o+1]="";const t=(l-1-o).toString().length;for(let e=0;e<r[o].length/(t+1);e++){const a=e*(t+1),i=e*(t+1)+1,n=r[o].slice(a,i).charCodeAt(0)^s+l-1-o,c=String.fromCharCode(n);r[o+1]+=c}}try{return JSON.parse(r[o])}catch(t){throw console.log("復号に失敗しました"),"復号エラー"}}},F=t=>new Promise((e=>setTimeout(e,t)));function C(e,a){"string"==typeof a?(0,t.writeFileSync)(e,a):(0,t.writeFileSync)(e,JSON.stringify(a))}async function L(t="",e,a){let s=0;e.miss_count=0,e.access_dot={waitmsec:1e3,max_quant:3};let o={bf:[],af:[]},i={bf:[],af:[]},r={};o.bf=a.bf.map((t=>t.name)),o.af=a.af.map((t=>t.name)),i.bf=a.bf.map((t=>t.url)),i.af=a.af.map((t=>t.url));for(let t=0;t<a.bf.length;t++)r[o.bf[t]]=i.bf[t];for(let t=0;t<a.af.length;t++)r[o.af[t]]=i.af[t];const w=e.sola.url,u=new function(){this.start=(new Date).valueOf(),this.limit_msec=()=>{return 24*(t={days:1,hours:0,minutes:0,seconds:0}).days*60*60*1e3+60*t.hours*60*1e3+60*t.minutes*1e3+1e3*t.seconds;var t},this.end=this.start+this.limit_msec()};setInterval((()=>{(new Date).valueOf()>u.end&&(console.log(`${c.fg_yellow}一時間操作がなかったためタイムアウトしました。${c.fg_reset}`),process.exit(0))}),1e3);let d=null;t:for(;;){let a;null!==d&&(0,y.clearInterval)(d),e.sola.url=w;const i={head:[[`SUS_login_v${t}`],[`${c.fg_green}十字キーで開きたい項目を選択してね${c.fg_reset}`,`インターネット接続状況：${c.bg_green}良好${c.bg_reset}`],[""]],body:[["1.euc",">>logs",">>images"],["2.sola",">>List","@ SOLAリスト更新"],["3.sclass"],["4.sclassとsola"],["5.履修仮組みツール"],[`${c.fg_red}6.QUIT${c.fg_reset}`]],foot:[[""],["選択?>"]]},h={head:[[`SUS_login_v${t}`],[`${c.fg_green}十字キーで開きたい項目を選択してね${c.fg_reset}`,`インターネット接続状況：${c.bg_red}不良${c.bg_reset}`],[`${c.fg_yellow}※ ネットワークが繋がっていないため${c.fg_red}QUIT${c.fg_reset}以外の操作を拒絶中です！${c.fg_reset}`],[""]],body:[["1.euc",">>logs",">>images"],["2.sola",">>List","@ SOLAリスト更新"],["3.sclass"],["4.sclassとsola"],["5.履修仮組みツール"],[`${c.fg_red}6.QUIT${c.fg_reset}`]],foot:[[""],["選択?>"]]},p={bf:{head:[[`前期solaリンク選択はぁと${c.fg_red} ❤ ${c.fg_reset}`],[""]],body:o.bf.map((t=>[t])),foot:[[""],["選択?>"]]},af:{head:[[`後期solaリンク選択はぁと${c.fg_red} ❤ ${c.fg_reset}`],[""]],body:o.af.map((t=>[t])),foot:[[""],["選択?>"]]}},$={home:await b.build(i,h),bf:await b.build(p.bf,h),af:await b.build(p.af,h)};let x=await m();d=setInterval((async()=>{const t=await m();if(t!==x){for(const t in $)await(await $[t].setStatus()).setMenu($[t].errorStatus);x=t}}),50),a=await l($.home),u.now=(new Date).valueOf();let k=[[["euc"],["logs"],["images"]],[["sola"],["solalist"],["list_reload"]],[["sclass"]],[["sclass","sola"]],[["course_registration"]],[["quit"]]][a.index[0]][a.index[1]];if("quit"===k[0])break t;if(await m())switch(k[0]){case"euc":if(console.log(`EUCを入力してください\n${c.fg_yellow}※キャンセルする場合は何も入力せずエンターをおしてね${c.fg_reset}`),s=await n("euc?>"),e.miss_count=0,""===s)break;await E(k,s,e).catch((t=>{console.log(t)})),await f("pass","[エンターを押して選択に戻る]");break;case"logs":console.log("EUCログを開きます"),(0,_.execSync)("start logs/euc.log"),await f("pass","[エンターを押して選択に戻る]");break;case"images":console.log("EUCスクリーンショットを開きます"),(0,_.execSync)("start images"),await f("pass","[エンターを押して選択に戻る]");break;case"sclass":case"sola":await E(k,s,e),await f("pass","[エンターを押して選択に戻る]");break;case"solalist":$.bf.body.push([`${c.fg_yellow}<<戻る${c.fg_reset}`,`${c.fg_green}>>後期ページへ${c.fg_reset}`]),$.af.body.push([`${c.fg_yellow}<<戻る${c.fg_reset}`,`${c.fg_green}>>前期ページへ${c.fg_reset}`]);let t=g.whichTerm();e:for(;;){if(a=await l($[t]),"5.QUIT"===a.str)break t;if(await m())switch(a.str){case">>後期ページへ":t="af";continue e;case">>前期ページへ":t="bf";continue e;case"<<戻る":continue t;default:k=["sola"],e.sola.url=r[a.str],await E(k,s,e),await f("pass","[エンターを押してリストに戻る]");continue e}}case"list_reload":console.clear(),console.log("履修科目データの更新を行います"),await F(1500),console.log(`${c.fg_yellow}※ 科目データの更新には、回線の都合上3分ほどかかる場合がありますので、このままお待ち下さい${c.fg_reset}`);try{const t=await S(e);C("resource/data/info.json",await v.encrypt(e)),C("resource/data/sola_link.json",await v.encrypt(t))}catch(t){throw new Error(`${c.fg_red}\n科目データの更新に失敗しました。${c.fg_reset}\nネットワークの接続状況を確認して、再実行してください。それでも失敗するようでしたら、${c.fg_cyan}infoClear.exe${c.fg_reset}を実行して初期化ののちもう一度最初から登録を行ってください。\n`)}await f("pass","[エンターを押して選択に戻る]");break;case"course_registration":console.log(`${c.bg_yellow}[只今工事中・・・ごめんぴ☆ミ]${c.bg_reset}`),await f("pass","[エンターを押して選択に戻る]");break;default:await f("pass","[エンターを押して選択に戻る]")}}return 0}async function E(t,a,s){if("euc"!==t[0]&&"sclass"!==t[0]&&"sola"!==t[0])return 0;const o=await(0,e.launch)({headless:"euc"===t[0]&&"new",slowMo:(t[0],0),defaultViewport:null,channel:"chrome",ignoreHTTPSErrors:!0,ignoreDefaultArgs:["--disable-extensions","--enable-automation"],args:["--proxy-server='direct://'","--proxy-bypass-list=*"]}).catch((()=>{throw new Error(c.fg_red+"ブラウザが開きませんでした。chromeがインストールされていることを確認してください。"+c.bg_reset)})),i=await o.createIncognitoBrowserContext(),r=await o.pages();"euc"!==t[0]&&await r[0].close();for(const e of t){if(s.miss_count=0,s.clg_count=0,"sclass"===e){await i.newPage();let t=await i.pages();for(;;)try{await A(i,s),t=await i.pages(),await t[Math.max(t.length-2,0)].close();break}catch(e){if(t=await i.pages(),!(t.length-1>0))break;await t[t.length-1].close();for(let t=0;t<s.clg_count;t++)process.stdout.write(`${c.up}${c.lineClear}`);if(console.log(`${c.bg_yellow}${c.fg_black}接続エラー(${s.miss_count+1})：接続に失敗しました再試行します。${c.fg_reset}`),3===s.miss_count){console.log(`\n${c.bg_red}アクセスエラー：sclassへのアクセスに失敗しました。ネットワークが混雑している可能性があるので、しばらく時間をおいて再度試してください。${c.bg_reset}\n`),t=await i.pages(),await t[Math.max(t.length-2,0)].close();break}s.miss_count++,await F(1e3)}}if("sola"===e){await i.newPage();let t=await i.pages();for(;;)try{await O(i,s),t=await i.pages(),await t[Math.max(t.length-2,0)].close();break}catch(e){if(t=await i.pages(),!(t.length-1>0))break;await t[t.length-1].close();for(let t=0;t<s.clg_count;t++)process.stdout.write(`${c.up}${c.lineClear}`);if(console.log(`${c.bg_yellow}${c.fg_black}接続エラー(${s.miss_count+1})：接続に失敗しました再試行します。${c.fg_reset}`),3===s.miss_count){console.log(`\n${c.bg_red}アクセスエラー：solaへのアクセスに失敗しました。ネットワークが混雑している可能性があるので、しばらく時間をおいて再度試してください。${c.bg_reset}`),t=await i.pages(),await t[Math.max(t.length-2,0)].close();break}s.miss_count++,await F(1e3)}}if("euc"===e){for(;;)try{await T(i,s,a);break}catch(t){for(let t=0;t<s.clg_count;t++)process.stdout.write(`${c.up}${c.lineClear}`);if(console.log(`${c.bg_yellow}${c.fg_black}接続エラー(${s.miss_count+1})：接続に失敗しました再試行します。${c.fg_reset}`),3===s.miss_count){await o.close(),console.log(`\n${c.bg_red}登録エラー：EUCの登録に失敗しました。ネットワークが混雑している可能性があるので、しばらく時間をおいて再度試してください。${c.bg_reset}`);break}s.miss_count++,await F(300)}await o.close()}}}class P{constructor(t){this.max_dot_quant=t.access_dot.max_quant,this.waitmsec=t.access_dot.waitmsec,this.waitAccess=void 0}async on(){process.stdout.write("アクセス中です");let t=0;return this.waitAccess=setInterval((()=>{t===this.max_dot_quant?(process.stdout.write(`[${2*t}D${c.rightClear}`),t=0):(process.stdout.write("・"),t++)}),this.waitmsec),this.waitAccess}async off(){this.waitAccess,process.stdout.write(`${c.lineClear}${c.initialLine()}`),(0,y.clearInterval)(this.waitAccess)}}async function A(t,e){const a=e.sclass,s=e.username,o=e.password,i=await t.newPage(),r=a.url,n=new P(e);await n.on();try{await i.goto(r,{waitUntil:"networkidle2",timeout:0}).catch((async()=>(await n.off(),new Promise.reject))),process.stdout.write(`${c.lineClear}${c.initialLine()}${c.fg_green}アクセス完了${c.fg_reset}\n`),await n.off();const t=a.target.name,l=a.target.pass,w=a.target.submit;if(await i.waitForSelector(w,{visible:!0,timeout:15e3}),await i.click(w),await i.waitForSelector(t,{visible:!0,timeout:15e3}),await i.click(t),await i.type(t,s),await i.waitForSelector(l,{visible:!0,timeout:15e3}),await i.click(l),await i.type(l,o),await i.waitForSelector(w,{visible:!0,timeout:15e3}),await i.click(w),await i.waitForSelector("span#htmlErrorMessage",{visible:!0,timeout:2500}).then((()=>!0)).catch((()=>!1)))throw new Error("Input Error : 不正な領域にユーザー名あるいはパスワードが入力されたためsclass側でエラーが出ました。");console.log(`\n${c.bg_green}sclassログイン完了${c.fg_reset}`),e.clg_count++}catch(t){throw await n.off(),new Error(`${c.bg_red}[ERROR]${c.bg_reset}\n+${t}`)}}async function O(t,e){const a=e.sola,s=e.username,o=e.password,i=await t.newPage(),r=a.url,n=new P(e);await n.on();try{await i.goto(r,{waitUntil:"networkidle2",timeout:0}),await n.off(),process.stdout.write(`${c.lineClear}${c.fg_green}${c.initialLine()}アクセス完了${c.fg_reset}\n`);const t=a.target.name,l=a.target.pass,w=a.target.submit;await i.waitForSelector(t,{visible:!0,timeout:3e4}),await i.type(t,s),await i.click(w),await i.waitForSelector(l,{visible:!0,timeout:3e4}),await i.type(l,o),await i.click(l),await i.click(w,{delay:800}),await i.waitForNavigation({waitUntil:"load",timeout:2e3}).catch((async()=>{await i.click(w,{delay:800})})),console.log(`\n${c.bg_green}SOLAログイン完了${c.fg_reset}`),e.clg_count++}catch(t){throw await n.off(),new Error(`${c.bg_red}[ERROR]${c.bg_reset}\n+${t}`)}}async function T(e,a,s){const o=a.sclass,i=a.username,r=a.password;a.clg_count=0;const n=await e.newPage(),l=o.url;await n.setRequestInterception(!0),n.on("request",(t=>{-1!==["image","stylesheet","font","script"].indexOf(t.resourceType())?t.abort():t.continue()}));const w=new P(a);await w.on();try{await n.goto(l,{waitUntil:"networkidle0",timeout:2e4}),await w.off(),process.stdout.write(`${c.lineClear}${c.fg_green}${c.initialLine()}アクセス完了${c.fg_reset}\n`);const u=o.target.name,d=o.target.pass,h=o.target.submit;await n.waitForSelector(h,{timeout:2e4}),await n.click(h),await n.waitForSelector(u,{timeout:2e4}),await n.type(u,i),await n.waitForSelector(d,{timeout:2e4}),await n.type(d,r),await n.waitForSelector(h,{timeout:2e4}),await n.click(h),console.log(`${c.bg_green}sclassログイン完了${c.fg_reset}`),a.clg_count++,await n.evaluate((()=>{window.scroll(0,0)}));const f="div#pmenu4";await n.waitForSelector(f,{visible:!0,timeout:3e4}),await n.hover(f);const _=await n.$eval(f,(t=>`#${Array.from(t.children).filter((t=>"EUC学生出欠登録"===t.text))[0].id}`));await n.waitForSelector(_,{visible:!0,timeout:3e4}),await n.click(_);const p="input.inputText",m="input.button";await n.waitForSelector(p,{visible:!0,timeout:0}),await n.type(p,s),n.on("dialog",(async t=>{await t.accept()})),await n.click(m),await n.waitForSelector("td span.outputText",{timeout:1e4});const y=await n.$eval("td span#form1\\3A Title",(t=>t.textContent.replace(/[\t\n]/g,""))).catch((()=>"")),b=await n.$eval("td span#form1\\3A htmlTorokukekka",(t=>t.textContent));if(console.log(c.fg_cyan+y+"\n"+c.fg_reset+c.fg_red+b+c.fg_reset),"番号が異なります。"!==b){const e=await n.$("table.sennasi"),a=g.getToday();await e.screenshot({path:"images/"+y+"_"+a+".jpg",type:"jpeg",quality:100});const o=`授業名：${y},日付：${g.getTodayJP()},EUC番号：${s},結果：${b}\n`;if((0,t.existsSync)("logs/euc.log"))try{(0,t.appendFileSync)("logs/euc.log",o,"utf-8")}catch(t){console.log(c.fg_red+"logs/euc.logにEUCを書き込めませんでした。"+c.fg_reset)}else(0,t.writeFileSync)("logs/euc.log",o,"utf-8")}a.miss_count=0,await e.close()}catch(t){throw await w.off(),new Error(`${c.bg_red}[ERROR]${c.bg_reset}\n+${t}`)}}async function M(e){const a={username:"",password:"",sclass:{url:"https://s-class.admin.sus.ac.jp/up/faces/login/Com00504A.jsp",target:{name:".inputText",pass:".inputSecret",submit:"input[type=image]"}},sola:{url:"https://sola.sus.ac.jp/",target:{name:"#identifier",pass:"#password",submit:"button[type=submit]"}},last_upd:""};try{return(0,t.writeFileSync)(e,JSON.stringify(a)),"done"}catch(t){throw"fault"}}const R=require("path"),j=t=>new Promise((e=>setTimeout(e,t)));function U(e,a){"string"==typeof a?(0,t.writeFileSync)(e,a):(0,t.writeFileSync)(e,JSON.stringify(a))}async function q(e,a){if(![process.env.LOCALAPPDATA,process.env.PROGRAMFILES,process.env["PROGRAMFILES(X86)"]].filter(Boolean).map((e=>(0,t.existsSync)((0,R.join)(e,"\\Google\\Chrome\\Application\\chrome.exe")))).filter(Boolean).length)throw console.log(`${c.fg_red}[ERROR]${c.fg_reset}`),console.log(`${c.fg_red}chromeがインストールされていません！${c.fg_reset}`),console.log(`${c.fg_green}C:\\Program Files\\${c.fg_red}以下などにchromeをインストールしてから再起動してください!${c.fg_reset}`),console.log(`chrome公式ページのURL→${c.fg_cyan}[https://www.google.com/intl/ja_jp/chrome/]${c.fg_reset}`),"Chrome install error";try{let a=function(e=""){return JSON.parse((0,t.readFileSync)(e,"utf8"))}("resource/data/info.json");console.log("初回起動を確認しました・・・"),await j(1e3),console.clear(),console.log(`OpenSUS_v${e} へようこそ！`),console.log("ユーザー名(学籍番号)とパスワードの設定を行います。");const s=await n("UserName?>",!1);for(;;)try{const t=await n("PassWord?>",!0);if(console.log("確認のためもう一度パスワードを入力してください"),t===await n("PassWord?>",!0)){a.username=s,a.password=t;break}console.log("パスワードが一致しません。もう一度入力してください"),await j(1e3)}catch(t){console.log(`${c.fg_red}[登録エラー] ユーザー名及びパスワードの登録に失敗しました。もう一度再起動してください${c.fg_reset}`),process.exit()}console.log("ユーザー名及びパスワードを登録しました"),await j(1500),console.clear(),console.log("続いて、履修科目データの登録を行います"),console.log(`${c.fg_yellow}※ 科目データの登録には、回線の都合上3分ほどかかる場合がありますので、このままお待ち下さい${c.fg_reset}`);try{const t=await S(a);console.log("認証ファイルの暗号化を行います・・・"),U("resource/data/info.json",await v.encrypt(a)),U("resource/data/sola_link.json",await v.encrypt(t)),await j(2e3),console.log("\n設定が完了しました。次回起動時から本機能が使用可能になります。")}catch(t){console.log(`${c.fg_red}[登録エラー] 履修科目データの登録に失敗しました。以下の項目を確認してもう一度やり直してください\n            [考えられる原因]\n            ・ユーザー名またはパスワードの入力間違い\n            ・インターネットに接続されていない\n            ・S-ClassまたはSOLAのサーバーが落ちているなどの不具合\n            ${c.fg_reset}`),await f("exit","[何かキーを押して終了します]")}return 1}catch(t){return await v.decrypt("resource/data/info.json",a)}}!async function(){for(;;){console.clear();const e="4.5.5",a=(0,k.hostname)();try{t.existsSync("./images")||t.mkdirSync("./images"),t.existsSync("./logs")||(t.mkdirSync("./logs"),t.writeFileSync("./logs/euc.log","")),t.existsSync("./resource")&&t.existsSync("./resource/data")||t.mkdirSync("resource/data",{recursive:!0}),t.existsSync("./resource/data/info.json")||await M("./resource/data/info.json"),console.log(`${c.bg_yellow}セットアップ中です・・・・・・${c.bg_reset}`);const s=await q(e,a);if(1===s&&await f("exit","[何かキーを押して終了します]"),!t.existsSync("./resource/data/sola_link.json")){const t=await S(s).catch((async()=>{console.log(`${c.fg_red}[登録エラー] 履修科目データの登録に失敗しました。パスワードなどが正しいか確認してもう一度やり直してください${c.fg_reset}`),await f("exit","[何かキーを押して終了します]")}));U("resource/data/sola_link.json",await v.encrypt(t))}const o=await v.decrypt("resource/data/sola_link.json");if(!0===g.isStartNend(s.last_upd)){console.clear(),console.log("期を跨いだので履修科目データの更新を行います"),await j(1500),console.log(`${c.fg_yellow}※ 科目データの更新には、回線の都合上3分ほどかかる場合がありますので、このままお待ち下さい${c.fg_reset}`);try{const t=await S(s);U("resource/data/info.json",await v.encrypt(s)),U("resource/data/sola_link.json",await v.encrypt(t))}catch(t){throw new Error(`${c.fg_red}\n科目データの更新に失敗しました。${c.fg_reset}\nネットワークの接続状況を確認して、再実行してください。それでも失敗するようでしたら、${c.fg_cyan}infoClear.exe${c.fg_reset}を実行して初期化ののちもう一度最初から登録を行ってください。\n`)}}await L(e,s,o);break}catch(t){console.clear(),console.log("[ERROR]"),console.log(t),await f("pass","[何かキーを押して再起動します]")}}await f("exit","[何かキーを押して終了します]")}()})();